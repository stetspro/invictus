<% if current_user.route != [] %>
  <div class="card black-card route-card mb-3">
    <h5 class="card-header">
      <%= I18n.t('routing.route') %>
      <button class="btn btn-outline-danger float-right remove-route-btn"><%= I18n.t('routing.remove_route') %></button>
    </h5>
    <div class="card-body">
      <% path = [] %>
      <% current_user.route.each_with_index do |jg, index| %>
        <% jg = Jumpgate.find(jg) %>
        
        <% if index == 0 %>
          <% if jg.origin.system == current_user.system %>
            <% path << jg.destination.system.name %>
            <%= jg.origin.system.name %> <i class="fa fa-arrow-right fa-sm"></i> <%= jg.destination.system.name %>
          <% else %>
            <% path << jg.origin.system.name %>
            <%= jg.destination.system.name %> <i class="fa fa-arrow-right fa-sm"></i> <%= jg.origin.system.name %>
          <% end %>
        <% else %>
          <% if jg.destination.system.name == path.last %>
            <% path << jg.origin.system.name %>
            <i class="fa fa-arrow-right fa-sm"></i> <%= jg.origin.system.name %>
          <% else %>
            <% path << jg.destination.system.name %>
            <i class="fa fa-arrow-right fa-sm"></i> <%= jg.destination.system.name %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<div class="card black-card map-card mb-3">
  <h5 class="card-header"><%= I18n.t('navbar.map') %></h5>
  <div class="speech-bubble"></div>
  <div class="card-body" id="map">
    
  </div>
</div>

<style>
  #map {
    overflow: hidden;
    padding: 0;
  }
  
  .speech-bubble {
    z-index: 10;
    display: block;
    top: -1000px;
    left: -1000px;
  	position: absolute;
  	background: #5d5d5d;
  	border-radius: .4em;
  }
  
  .speech-bubble:after {
  	content: '';
  	position: absolute;
  	bottom: 0;
  	left: 50%;
  	width: 0;
  	height: 0;
  	border: 20px solid transparent;
  	border-top-color: #191919;
  	border-bottom: 0;
  	margin-left: -20px;
  	margin-bottom: -20px;
  }
</style>

<script>
  // create an array with nodes
    var nodes = new vis.DataSet([
      <% System.all.each do |sys| %>
        <% color = ["rgba(81, 203, 238, 1)", "#FF8C00", "red"] %>
        {id: <%= sys.id %>, label: "<%= sys.get_faction.get_ticker if sys.get_faction %> <%= sys.name %>", image: "<%= image_url("planets/star_#{sys.security_status}.png") %>", font: {<%= "size: 20, color: 'yellow'".html_safe if current_user.system == sys %>} },
      <% end %>
    ]);

    // create an array with edges
    var edges = new vis.DataSet([
      <% cache Jumpgate do %>
        <% Jumpgate.includes(:origin => :system, :destination => :system).all.each do |jg| %>
          {id: <%= jg.id %>, from: <%= jg.origin.system.id %>, to: <%= jg.destination.system.id %>},
        <% end %>
      <% end %>
    ]);

    // create a network
    var container = document.getElementById('map');

    // provide the data in the vis format
    var data = {
        nodes: nodes,
        edges: edges
    };
    
    // set options
    var options = {
      autoResize: true,
      height: '600px',
      width: '100%',
      nodes: {
        shape: 'image',
        size: 20,
        fixed: true,
        font: { color: 'white' }
      },
      edges: {
        color: { color: 'grey' },
        selectionWidth: 0
      },
      physics: { enabled: false },
      // Seeds: 626344
      layout: { randomSeed: 576136 },
      interaction: { selectConnectedEdges: false }
    };

    // initialize your network!
    var network = new vis.Network(container, data, options);
    
    // get info from node on select
    network.on("click", function (params) {
      if (params.nodes) {
        var id = params.nodes[0]
        var position = network.canvasToDOM(network.getPositions([id])[id])
        
        $.get('system/info', {id: id}, function(data) {
          $('.speech-bubble').html(data);
          setTimeout(function() { 
            $('.speech-bubble').css({position: 'absolute', top: position.y-$('.speech-bubble').height()+10, left: position.x-($('.speech-bubble').width() / 2)}); 
          }, 10)
        }); 
      }
    });
    
    network.on("zoom", function () {
      $('.speech-bubble').css({position: 'absolute', top: -1000, left: -1000, display: 'block'}); 
    });
    
    network.on("dragStart", function () {
      $('.speech-bubble').css({position: 'absolute', top: -1000, left: -1000, display: 'block'}); 
    });
    
    // draw route if user has one
    <% if current_user.route %>
      <% current_user.route.each do |step| %>
        var edge = edges.get(<%= step %>);
        edges.remove(<%= step %>);
        edges.add({id: <%= step %>, from: edge.from, to: edge.to, color: { color: 'red' }, width: 5});
      <% end %>
    <% end %>

    // create route button
    $('.speech-bubble').on('click', '.get-route-btn', function() {
      var id = $(this).data('id');
      
      loading_animation($(this));
      $.post('system/route', {id: id}, function(data) {
        Turbolinks.visit(window.location);
      });
    });
    
    // remove route button
    $('.remove-route-btn').on('click', function(){
      loading_animation($(this));
      $.post('system/clear_route', function() {
        Turbolinks.visit(window.location);
      });
    });
</script>
